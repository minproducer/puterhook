<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <title>AI Webhook GPT-4o</title>

    <!-- SDK Ä‘áº§y Ä‘á»§ (Auth + AI) -->
    <script src="https://js.puter.com/v2/"></script>

    <style>
        body {
            font-family: monospace;
            background: #f7f7f7;
            margin: 40px;
        }

        #out {
            background: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            white-space: pre-wrap;
        }

        #login {
            padding: 10px 20px;
            margin-top: 20px;
            display: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <pre id="out">Äang khá»Ÿi táº¡oâ€¦</pre>
    <button id="login">ğŸ” ÄÄƒng nháº­p vá»›i Puter</button>

    <script>
        (async () => {
            await puter.ready;
            const $out = document.getElementById('out');
            const $login = document.getElementById('login');
            const show = (obj) => $out.textContent = JSON.stringify(obj, null, 2);

            /* â”€â”€ Tiá»‡n Ã­ch Ä‘áº·t MIME JSON â”€â”€ */
            const setJsonMime = () => {
                const m = document.createElement('meta');
                m.httpEquiv = 'Content-Type';
                m.content = 'application/json; charset=utf-8';
                document.head.appendChild(m);
            };

            /* â”€â”€ HÃ m Ä‘Äƒng nháº­p â”€â”€ */
            const signIn = () => puter.auth.signIn({
                mode: 'popup',          // cÃ³ thá»ƒ Ä‘á»•i thÃ nh 'redirect'
                provider: 'google'      // 'github', 'discord'â€¦ náº¿u muá»‘n
            });

            let user = puter.auth.currentUser;

            if (!user) {
                $login.style.display = 'inline-block';
                $out.textContent = 'Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ dÃ¹ng dá»‹ch vá»¥ AI.';
                $login.onclick = async () => {
                    try {
                        user = await signIn();
                        $login.style.display = 'none';
                        runWebhook();
                    } catch (e) {
                        show({ error: 'KhÃ´ng Ä‘Äƒng nháº­p Ä‘Æ°á»£c', detail: e.message });
                    }
                };
                return;                               // dá»«ng â€“ chá» Ä‘Äƒng nháº­p
            }

            runWebhook();                           // Ä‘Ã£ cÃ³ phiÃªn

            /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
               THá»°C THI WEBHOOK (khÃ´ng lÆ°u bá»™ nhá»›)
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            async function runWebhook() {
                setJsonMime();

                const params = new URLSearchParams(location.search);
                const question = params.get('q');

                if (!question) {
                    show({ error: 'Thiáº¿u tham sá»‘ ?q=' });
                    return;
                }

                try {
                    const answer = await puter.ai.chat(question, { model: 'gpt-4o' });
                    show({
                        question,
                        answer,
                        user: { id: user.id, username: user.username }
                    });
                } catch (err) {
                    if (err.status === 401 || err.code === 'token_auth_failed') {
                        await puter.auth.signOut();
                        show({ error: 'PhiÃªn háº¿t háº¡n, hÃ£y táº£i láº¡i vÃ  Ä‘Äƒng nháº­p.' });
                        $login.style.display = 'inline-block';
                    } else if (err.code === 'rate_limited') {
                        show({ error: 'VÆ°á»£t háº¡n má»©c, thá»­ láº¡i sau.' });
                    } else {
                        show({ error: err.message || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh.' });
                    }
                }
            }
        })();
    </script>
</body>

</html>